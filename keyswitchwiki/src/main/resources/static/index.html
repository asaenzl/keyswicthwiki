let allSwitches = [];
let currentFilter = 'ALL';

// Detect if running locally or in production
const API_URL = window.location.hostname === 'localhost'
? 'http://localhost:8080'
: window.location.origin;

// Cargar switches al iniciar
async function loadSwitches() {
try {
const response = await fetch(`${API_URL}/api/switches`);
allSwitches = await response.json();
displaySwitches(allSwitches);
} catch (error) {
console.error('Error loading switches:', error);
document.getElementById('switchesContainer').innerHTML =
'<div class="no-results">Error al cargar los switches. Asegúrate que el servidor esté corriendo.</div>';
}
}

// Mostrar switches
function displaySwitches(switches) {
const container = document.getElementById('switchesContainer');

if (switches.length === 0) {
container.innerHTML = '<div class="no-results">No se encontraron switches</div>';
return;
}

container.innerHTML = switches.map(sw => `
<div class="switch-card">
    <img src="${API_URL}/api/switches/${sw.id}/image"
         class="switch-image"
         alt="${sw.brand} ${sw.model}"
         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23f0f0f0%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2220%22%3ESin imagen%3C/text%3E%3C/svg%3E'">
    <div class="switch-info">
        <div class="switch-header">
            <div>
                <div class="switch-name">${sw.brand} ${sw.model}</div>
                <div class="switch-brand">${sw.brand}</div>
            </div>
            <span class="switch-type type-${sw.switchType.toLowerCase()}">${sw.switchType}</span>
        </div>
        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">${sw.description || ''}</p>
        <div class="switch-specs">
            <div class="spec-item">
                <div class="spec-label">Fuerza</div>
                <div class="spec-value">${sw.actuationForceGrams || 'N/A'}g</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Precio</div>
                <div class="spec-value">$${sw.typicalPriceUsd || 'N/A'}</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Recorrido</div>
                <div class="spec-value">${sw.totalTravelMm || 'N/A'}mm</div>
            </div>
            <div class="spec-item">
                <div class="spec-label">Lubricado</div>
                <div class="spec-value">${sw.isFactoryLubed ? 'Sí' : 'No'}</div>
            </div>
        </div>
    </div>
</div>
`).join('');
}

// Filtrar por tipo
document.querySelectorAll('.filter-btn').forEach(btn => {
btn.addEventListener('click', () => {
document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');

currentFilter = btn.dataset.type;
filterAndSearch();
});
});

// Buscar
document.getElementById('searchInput').addEventListener('input', (e) => {
filterAndSearch();
});

// Aplicar filtros y búsqueda
function filterAndSearch() {
let filtered = allSwitches;

// Filtrar por tipo
if (currentFilter !== 'ALL') {
filtered = filtered.filter(sw => sw.switchType === currentFilter);
}

// Buscar por texto
const searchTerm = document.getElementById('searchInput').value.toLowerCase();
if (searchTerm) {
filtered = filtered.filter(sw =>
sw.brand.toLowerCase().includes(searchTerm) ||
sw.model.toLowerCase().includes(searchTerm)
);
}

displaySwitches(filtered);
}

// Cargar switches al iniciar
loadSwitches();